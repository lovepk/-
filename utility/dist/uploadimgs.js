define(function(b,a,c){b("../lib/webuploader.js");var e={$showImglist:"#imglist",$uploaded:"#uploaded"};function d(f){this.opt=$.extend({},e,f);this.init();}d.prototype={init:function(){var f=this;this.elShowList=$(f.opt.$showImglist);this.elUped=$(f.opt.$uploaded);this.elUpbtn=$(f.opt.$upbtn);this.memoryImgs=$(f.opt.$memoryImgs);this.selbtn=$(f.opt.$selbtn);this.bind();this.css();this.initImgList();this.countShowNum();},initImgList:function(){var h=this;var i=this.memoryImgs.val(),f=JSON.parse(i);if(f.length==0){console.log("no info!");return;}var g=new Array();$.each(f,function(j,k){if(typeof k.url==="undefined"||k.url===""){return;}var l=$(['<div id="'+k.fid+'" class="img-item thumbnail">','<img src="'+k.url+'" /><a href="javascript:;" class="del"></a>',"</div>"].join(""));l.insertBefore(h.selbtn);g.push(k);});f=g;h.memoryImgs.val(JSON.stringify(f));$("#upednum").text("已上传"+f.length+"/3");},countShowNum:function(){var f=this;var g=$(".img-item").length;if(g==3){f.selbtn.hide();}if(g<3){f.selbtn.show();}},bind:function(){var f=this;f.elUpbtn.click(function(g){if(f.uploader.getFiles().length==0){$("#errmsg .errmsg").text("没有可上传的图片!").show().delay(1000).fadeOut();}else{f.uploader.upload();}});f.elShowList.on("mouseover",".webuploader-pick",function(){f.uploader.refresh();});f.elShowList.off("click",".del").on("click",".del",function(g){g.preventDefault();f.delmemoryImg($(this));});f.uploader=WebUploader.create({server:f.opt.server,pick:f.opt.$selbtn,fileSingleSizeLimit:512*1024,fileNumLimit:3,accept:f.opt.accept,compress:false,});f.uploader.on("fileQueued",function(i){if(f.elShowList.find(".img-item").length>=3){$("#errmsg .errmsg").text("最多上传三张图片").show().delay(1000).fadeOut();f.uploader.removeFile(i,true);return;}var l=$('<div id="'+i.id+'" class="img-item thumbnail"><img><a href="javascript:;" class="del"></a></div>'),h=l.find("img");l.insertBefore(f.selbtn);l.off("click",".del").on("click",".del",function(){f.uploader.removeFile(i,true);f.delmemoryImg($(this),i.id);});f.uploader.makeThumb(i,function(m,n){if(m){h.replaceWith("<span>不能预览</span>");return;}h.attr("src",n);},f.opt.width,f.opt.height);var k=f.memoryImgs.val(),g=JSON.parse(k);var j={fid:i.id};g.push(j);f.memoryImgs.val(JSON.stringify(g));f.countShowNum();});f.uploader.on("fileDequeued",function(){});f.uploader.on("uploadSuccess",function(k,j){if(!j.success){var m=f.memoryImgs.val(),g=JSON.parse(m);var l=new Array();for(var h=0;h<g.length;h++){if(k.id===g[h].fid){f.uploader.removeFile(k,true);$("#"+k.id).remove();}else{l.push(g[h]);}}g=l;f.memoryImgs.val(JSON.stringify(g));}else{f.opt.addCallback(k,j);}});f.uploader.on("error",function(g){switch(g){case"Q_TYPE_DENIED":err_msg="图片类型不正确";break;case"Q_EXCEED_NUM_LIMIT":err_msg="最多3张图片";break;case"Q_EXCEED_SIZE_LIMIT":case"F_EXCEED_SIZE":err_msg="图片大小不得超过512k";break;case"F_DUPLICATE":err_msg="请勿上传重复图片";break;default:err_msg=g;break;}$("#errmsg .errmsg").text(err_msg).show().delay(1000).fadeOut();});f.uploader.on("uploadError",function(h,g){console.log("错误信息");});f.uploader.on("uploadComplete",function(){console.log("complete");});f.uploader.on("uploadFinished",function(){console.log("finshed");f.uploader.reset();});},delmemoryImg:function(m,l){var g=this,k=g.memoryImgs.val()||[],f=JSON.parse(k),h=m.closest(".img-item").find("img").attr("src");m.closest(".img-item").remove();g.countShowNum();for(var j=0;j<f.length;j++){if(h&&h==f[j].url){f.splice(j,1);$("#upednum").text("已上传"+f.length+"/3");g.memoryImgs.val(JSON.stringify(f));return;}if(f[j].fid==l){f.splice(j,1);$("#upednum").text("已上传"+f.length+"/3");g.memoryImgs.val(JSON.stringify(f));return;}}},css:function(){var f='@charset "utf-8";.webuploader-element-invisible{clip:rect(1px,1px,1px,1px);position:absolute !important;}';var h=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(h);if(h.styleSheet){if(!h.styleSheet.disabled){h.styleSheet.cssText=f;}}else{try{h.innerHTML=f;}catch(g){h.innerText=f;}}}};return function(f){new d(f);};});